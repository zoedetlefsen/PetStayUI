<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>PetStay Check-In</title>
  <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="/assets/css/checkin.css">
  <script defer src="https://cdn.jsdelivr.net/npm/aws-amplify@latest/dist/aws-amplify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/js/config.js"></script>
  <!-- Toastify (for stylish toast messages) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

</head>

<body class="bg-light">
  <div class="container mt-5 text-center">
    <h2 class="mb-4">üêæ PetStay Check-In</h2>
    <div id="result" class="alert alert-info">Loading booking details...</div>
    <div id="roomInfo" class="mt-3 fw-bold text-primary"></div>
  </div>

  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="checkinToast" class="toast text-white bg-success border-0" role="alert" aria-live="polite"
      aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="checkinToastMsg">Check-in successful!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script>
    const allowedStaffEmails = window.PETSTAY_CONFIG.ALLOWED_STAFF_EMAILS || [
      "petstayteam@outlook.com", "petstayteam@gmail.com", "zoedetlefsen@rogers.com"
    ];

    let bookingId = null;

    document.addEventListener("DOMContentLoaded", async function () {
      const { default: Amplify, Auth } = window.aws_amplify;
      const urlParams = new URLSearchParams(window.location.search);

      bookingId = urlParams.get('bookingId') || sessionStorage.getItem('bookingId');
      const fromLogin = urlParams.get('fromLogin') || sessionStorage.getItem('fromLogin');

      // Clean up URL status param
      urlParams.delete('status');
      if (bookingId) {
        window.history.replaceState({}, document.title, `${window.location.pathname}?bookingId=${bookingId}`);
      }

      if (!bookingId) {
        document.getElementById("result").innerHTML = `
        <span class='text-danger'>Invalid QR Code. Booking ID is missing.</span>
        <p class="mt-2">Please scan again or open the link in a browser.</p>`;
        return;
      }

      if (!Amplify || !Amplify.configure) {
        console.error("AWS Amplify not available.");
        return;
      }

      Amplify.configure({
        Auth: {
          region: window.PETSTAY_CONFIG.AWS_REGION,
          userPoolId: window.PETSTAY_CONFIG.COGNITO_USER_POOL_ID,
          userPoolWebClientId: window.PETSTAY_CONFIG.COGNITO_USER_POOL_CLIENT_ID,
          oauth: {
            domain: window.PETSTAY_CONFIG.COGNITO_DOMAIN,
            scope: ['email', 'openid', 'phone'],
            redirectSignIn: window.PETSTAY_CONFIG.REDIRECT_SIGN_IN_URL,
            redirectSignOut: window.PETSTAY_CONFIG.REDIRECT_SIGN_OUT_URL,
            responseType: 'code'
          }
        }
      });

      await fetchBookingDetails(bookingId);

      if (fromLogin === "1") {
        await checkInAfterLogin();
      }
    });

    async function fetchBookingDetails(bookingId) {
      try {
        const response = await fetch(`${window.PETSTAY_CONFIG.BOOKING_API_URL}/${bookingId}?t=${Date.now()}`);
        const booking = await response.json();

        if (response.ok && booking.bookingId) {
          renderBookingInfo(booking);
        } else {
          document.getElementById("result").innerHTML = "<span class='text-danger'>No booking found.</span>";
        }
      } catch {
        document.getElementById("result").innerHTML = "<span class='text-danger'>Failed to load booking info.</span>";
      }
    }

    function renderBookingInfo(booking) {
      let checkInButtonHTML = "";

      if (booking.Status === 'Confirmed') {
        checkInButtonHTML = `
        <p class="text-muted">To protect your booking, a PetStay staff member must complete check-in.<br>
        Please show this page at the front desk.</p>
        <button id="checkinButton" class="btn btn-primary mt-2" onclick="loginThenCheckIn()">Staff: Continue to Check-In</button>`;
      } else if (booking.Status === 'Checked-In') {
        checkInButtonHTML = `<div class="text-success fw-bold">Already checked in.</div>`;
        if (booking.RoomNumber) {
          document.getElementById("roomInfo").innerText = `Room Assigned: ${booking.RoomNumber}`;
        }
      } else if (booking.Status === 'Checked-Out') {
        checkInButtonHTML = `<div class="text-secondary fw-bold">üêæ Thank you for choosing PetStay!</div>`;
      } else {
        checkInButtonHTML = `<div class="text-warning fw-bold">Awaiting admin confirmation before check-in.</div>`;
      }

      document.getElementById("result").innerHTML = `
      <h5 class="text-success">Booking Found</h5>
      <p><strong>Owner:</strong> ${booking.OwnerName}</p>
      <p><strong>Pet:</strong> ${booking.PetName} (${booking.PetSpecies})</p>
      <p><strong>Status:</strong> 
        <span class="badge bg-${booking.Status === 'Checked-In' ? 'success' : booking.Status === 'Confirmed' ? 'primary' : booking.Status === 'Checked-Out' ? 'secondary' : 'warning'}">${booking.Status}</span>
      </p>
      ${checkInButtonHTML}`;
    }

    function loginThenCheckIn() {
      const bookingId = new URLSearchParams(window.location.search).get("bookingId");
      if (!bookingId) {
        alert("Booking ID missing from URL. Cannot proceed to login.");
        return;
      }

      // Store values in sessionStorage so they persist across the redirect
      sessionStorage.setItem("bookingId", bookingId);
      sessionStorage.setItem("fromLogin", "1");

      //Use only static URI that is whitelisted in Cognito console
      const redirectUri = `${window.location.origin}/checkin.html`;

      // Construct login URL with static redirectUri
      const loginURL = `https://${window.PETSTAY_CONFIG.COGNITO_DOMAIN}/login` +
        `?client_id=${window.PETSTAY_CONFIG.COGNITO_USER_POOL_CLIENT_ID}` +
        `&response_type=code&scope=email+openid+phone` +
        `&redirect_uri=${encodeURIComponent(redirectUri)}`;

      window.location.href = loginURL;
    }


    async function checkInAfterLogin() {
      try {
        const { Auth } = window.aws_amplify;
        const user = await Auth.currentAuthenticatedUser({ bypassCache: true });

        let session;
        for (let i = 0; i < 5; i++) {
          try {
            session = await Auth.currentSession();
            break;
          } catch {
            await new Promise(res => setTimeout(res, 800));
          }
        }

        if (!session) return alert("Could not initialize session. Try again.");

        const email = session.getIdToken().payload.email.toLowerCase();
        if (!allowedStaffEmails.map(e => e.toLowerCase()).includes(email)) {
          alert(`You are not authorized to perform check-in.\nYour email: ${email}`);
          sessionStorage.removeItem("fromLogin"); // Clear just this
          return;
        }

        const bookingId = sessionStorage.getItem("bookingId") || new URLSearchParams(window.location.search).get("bookingId");
        if (!bookingId) return alert("Booking ID missing. Cannot perform check-in.");

        const res = await fetch(`${window.PETSTAY_CONFIG.CHECKIN_BOOKING_URL}`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${session.getIdToken().getJwtToken()}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ bookingId })
        });



        const result = await res.json();

        if (res.ok && (result.message?.includes("Checked-In") || result.newStatus === "Checked-In")) {
          await fetchBookingDetails(bookingId);
          document.getElementById("roomInfo").innerText = `Assigned Room: ${result.roomId || '‚Äî'}`;

          const checkInButton = document.getElementById("checkinButton");
          if (checkInButton) {
            checkInButton.disabled = true;
            checkInButton.innerText = "Checked In";
          }

          const statusElement = document.querySelector("span.badge");
          if (statusElement) {
            statusElement.textContent = "Checked-In";
            statusElement.classList.remove("bg-primary");
            statusElement.classList.add("bg-success");
          }

          // Show toast, clean URL, then clear session
          setTimeout(() => {
            history.replaceState({}, document.title, `${window.location.pathname}?bookingId=${bookingId}`);
            const toast = new bootstrap.Toast(document.getElementById("checkinToast"));
            toast.show();

            // Clear storage AFTER check-in is confirmed and toast shown
            sessionStorage.removeItem("fromLogin");
            sessionStorage.removeItem("bookingId");
          }, 800);

        } else {
          const errorMsg = result.message || "Unknown error";
          const lowerMsg = errorMsg.toLowerCase();

          if (lowerMsg.includes("room is full")) {
            Toastify({
              text: errorMsg.includes("dog")
                ? "Dog room is full. Please try another room."
                : errorMsg.includes("cat")
                  ? "Cat room is full. Please try another room."
                  : "Room is full. Please try again later.",
              duration: 4000,
              gravity: "top",
              position: "center",
              backgroundColor: "#ef4444"
            }).showToast();
          } else {
            Toastify({
              text: "üêæ Check-in failed: " + errorMsg,
              duration: 4000,
              gravity: "top",
              position: "center",
              backgroundColor: "#ef4444"
            }).showToast();
          }

          await fetchBookingDetails(bookingId);
        }

      } catch (err) {
        console.error("Check-in error:", err);
        Toastify({
          text: "Session expired or check-in failed. Please try again.",
          duration: 4000,
          gravity: "top",
          position: "center",
          backgroundColor: "#f97316"
        }).showToast();
      }
    }


    window.loginThenCheckIn = loginThenCheckIn;
  </script>

</body>

</html>